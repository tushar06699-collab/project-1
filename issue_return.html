<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Issue / Return Books</title>
<style>
  body{font-family:'Poppins',sans-serif;background:#f8f9fa;margin:0;padding:20px;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
  h2{margin:0;color:#022;}
  input,button{padding:10px;margin:6px;border-radius:8px;border:1px solid #ccc;}
  button{cursor:pointer;font-weight:600;border:none;}
  .btn-main{background:linear-gradient(90deg,#34d399,#3ec8ff);}
  .btn-danger{background:linear-gradient(90deg,#fb7185,#f97316);color:white;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;}
  th{background:#e7f3f0;}
  .details-box{background:white;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:10px;margin:10px 0;}
  .details-box p{margin:4px 0;}
</style>
</head>
<body>

<div class="topbar">
  <h2>ðŸ”„ Issue / Return Books</h2>
  <div>
    <button onclick="window.location.href='books.html'" class="btn-main">Go to Books</button>
    <button onclick="logout()" class="btn-danger">Logout</button>
  </div>
</div>

<div>
  <h3>ðŸ“˜ Issue Book</h3>
  <input id="issueBookId" placeholder="Enter Book Code" oninput="fetchBookDetails('issue')">
  <div id="issueDetails" class="details-box" style="display:none;"></div>
  <input id="issueTo" placeholder="Student Name / Roll No">
  <button onclick="issueBook()" class="btn-main">Issue</button>
</div>

<div>
  <h3>ðŸ“— Return Book</h3>
  <input id="returnBookId" placeholder="Enter Book Code" oninput="fetchBookDetails('return')">
  <div id="returnDetails" class="details-box" style="display:none;"></div>
  <button onclick="returnBook()" class="btn-main">Return</button>
</div>

<h3>ðŸ“‹ Records</h3>
<table id="record-table"></table>

<script>
if (localStorage.getItem("loggedIn") !== "true") window.location.href = "login.html";

const BOOKS_KEY = "booksData_v2";
const RECORDS_KEY = "recordsData_v2";

let books = JSON.parse(localStorage.getItem(BOOKS_KEY) || "[]");
let records = JSON.parse(localStorage.getItem(RECORDS_KEY) || "[]");

if (!Array.isArray(books)) books = [];
if (!Array.isArray(records)) records = [];

function fetchBookDetails(type) {
  const inputId = type === "issue" ? "issueBookId" : "returnBookId";
  const boxId = type === "issue" ? "issueDetails" : "returnDetails";
  const code = document.getElementById(inputId).value.trim();
  const box = document.getElementById(boxId);
  if (!code) { box.style.display = "none"; return; }

  const b = books.find(x => (x.code || "").toLowerCase() === code.toLowerCase());
  if (!b) {
    box.innerHTML = "<p style='color:red;'>Book not found!</p>";
    box.style.display = "block";
    return;
  }

  const available = (b.copies || 0) - (b.issuedCount || 0);

  box.style.display = "block";
  box.innerHTML = `
    <p><b>Book Name:</b> ${b.name || "-"}</p>
    <p><b>Author:</b> ${b.author || "-"}</p>
    <p><b>Publisher:</b> ${b.publisher || "-"}</p>
    <p><b>Available Copies:</b> ${available}</p>
  `;
}

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwS__xCuxsR6ejvA6eVa6gbkeESKHRBX8AuTBoFWPXyHyDRqoo-NNxLngIXMih-ZGg/exec";


/* ----------------------------------------------------
     âœ… CLOUD SYNC â€” LOAD DATA FROM GOOGLE SHEETS
-----------------------------------------------------*/
async function loadCloudRecords() {
  try {
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();

    records = [];

    data.forEach(r => {
      records.push({
        code: r.code,
        name: r.name,
        author: r.author,
        publisher: r.publisher,
        student: r.student,
        date: r.date,
        returnDate: r.returnDate,
        status: r.status
      });
    });

    save();
    render();
  } catch (err) {
    console.error("Cloud load error:", err);
  }
}


/* ----------------------------------------------------
                 ISSUE BOOK
-----------------------------------------------------*/
function issueBook() {
  const code = document.getElementById("issueBookId").value.trim();
  const student = document.getElementById("issueTo").value.trim();
  const b = books.find(x => (x.code || "").toLowerCase() === code.toLowerCase());

  if (!b) return alert("Book not found!");
  if (!student) return alert("Enter student name!");

  const available = (b.copies || 0) - (b.issuedCount || 0);
  if (available <= 0) return alert("No available copies left!");

  b.issuedCount = (b.issuedCount || 0) + 1;

  const record = {
    code: b.code,
    name: b.name,
    author: b.author,
    publisher: b.publisher,
    student,
    date: new Date().toLocaleString(),
    status: "Issued",
    returnDate: ""
  };

  records.push(record);
  save();
  render();

  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ...record, action: "ISSUE" })
  });

  alert(`ðŸ“˜ Book "${b.name}" issued to ${student}`);
  resetIssue();
}


/* ----------------------------------------------------
                 RETURN BOOK
-----------------------------------------------------*/
function returnBook() {
  const code = document.getElementById("returnBookId").value.trim();
  const b = books.find(x => (x.code || "").toLowerCase() === code.toLowerCase());
  if (!b) return alert("Book not found!");

  const lastIssued = [...records].reverse().find(x => x.code === b.code && x.status === "Issued");
  if (!lastIssued) return alert("No pending issue record found!");

  b.issuedCount = Math.max((b.issuedCount || 1) - 1, 0);

  lastIssued.status = "Returned";
  lastIssued.returnDate = new Date().toLocaleString();

  save();
  render();

  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ...lastIssued, action: "RETURN" })
  });

  alert(`ðŸ“— Book "${b.name}" returned`);
  resetReturn();
}


/* ----------------------------------------------------
                 DELETE RECORD
-----------------------------------------------------*/
function deleteRecord(index) {
  if (!confirm("Are you sure you want to delete this record?")) return;

  const rec = records[index];

  const b = books.find(x => x.code === rec.code);
  if (b && rec.status === "Issued") {
    b.issuedCount = Math.max((b.issuedCount || 1) - 1, 0);
  }

  records.splice(index, 1);
  save();
  render();

  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ...rec, action: "DELETE" })
  });
}


/* ----------------------------------------------------
                 RENDER TABLE
-----------------------------------------------------*/
function render() {
  const t = document.getElementById("record-table");
  t.innerHTML = `
    <tr>
      <th>Book Code</th>
      <th>Name</th>
      <th>Author</th>
      <th>Student</th>
      <th>Issue Date</th>
      <th>Status</th>
      <th>Return Date</th>
      <th>Delete</th>
    </tr>
  `;

  records.forEach((r, i) => {
    t.innerHTML += `
      <tr>
        <td>${r.code}</td>
        <td>${r.name}</td>
        <td>${r.author}</td>
        <td>${r.student}</td>
        <td>${r.date}</td>
        <td>${r.status}</td>
        <td>${r.returnDate || "-"}</td>
        <td><button class="btn-danger" onclick="deleteRecord(${i})">Delete</button></td>
      </tr>
    `;
  });
}


/* ----------------------------------------------------
                 UTILITIES
-----------------------------------------------------*/
function save() {
  localStorage.setItem(BOOKS_KEY, JSON.stringify(books));
  localStorage.setItem(RECORDS_KEY, JSON.stringify(records));
}

function resetIssue() {
  issueBookId.value = "";
  issueTo.value = "";
  document.getElementById("issueDetails").style.display = "none";
}

function resetReturn() {
  returnBookId.value = "";
  document.getElementById("returnDetails").style.display = "none";
}

function logout() {
  localStorage.removeItem("loggedIn");
  window.location.href = "login.html";
}


/* ----------------------------------------------------
     âš¡ LOAD CLOUD DATA ON PAGE START
-----------------------------------------------------*/
loadCloudRecords();
</script>

</body>
</html>
