<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Issue / Return Books</title>
<style>
  body{font-family:'Poppins',sans-serif;background:#f8f9fa;margin:0;padding:20px;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
  h2{margin:0;color:#022;}
  input,button{padding:10px;margin:6px;border-radius:8px;border:1px solid #ccc;}
  button{cursor:pointer;font-weight:600;border:none;}
  .btn-main{background:linear-gradient(90deg,#34d399,#3ec8ff);}
  .btn-danger{background:linear-gradient(90deg,#fb7185,#f97316);color:white;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;}
  th{background:#e7f3f0;}
  .details-box{background:white;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:10px;margin:10px 0;}
  .details-box p{margin:4px 0;}
</style>
</head>
<body>

<div class="topbar">
  <h2>ðŸ”„ Issue / Return Books</h2>
  <div>
    <button onclick="window.location.href='books.html'" class="btn-main">Go to Books</button>
    <button id="syncBtn" class="btn-main" title="Sync from cloud">Sync</button>
    <span id="syncStatus" style="margin-left:10px;font-size:0.9em;color:#066;"></span>
    <button onclick="logout()" class="btn-danger">Logout</button>
  </div>
</div>

<div>
  <h3>ðŸ“˜ Issue Book</h3>
  <input id="issueBookId" placeholder="Enter Book Code" oninput="fetchBookDetails('issue')">
  <div id="issueDetails" class="details-box" style="display:none;"></div>
  <input id="issueTo" placeholder="Student Name / Roll No">
  <button onclick="issueBook()" class="btn-main">Issue</button>
</div>

<div>
  <h3>ðŸ“— Return Book</h3>
  <input id="returnBookId" placeholder="Enter Book Code" oninput="fetchBookDetails('return')">
  <div id="returnDetails" class="details-box" style="display:none;"></div>
  <button onclick="returnBook()" class="btn-main">Return</button>
</div>

<h3>ðŸ“‹ Records</h3>
<table id="record-table"></table>

<script>
if (localStorage.getItem("loggedIn") !== "true") window.location.href = "login.html";

const BOOKS_KEY = "booksData_v2";
const RECORDS_KEY = "recordsData_v2";

let books = JSON.parse(localStorage.getItem(BOOKS_KEY) || "[]");
let records = JSON.parse(localStorage.getItem(RECORDS_KEY) || "[]");

if (!Array.isArray(books)) books = [];
if (!Array.isArray(records)) records = [];

function fetchBookDetails(type) {
  const inputId = type === "issue" ? "issueBookId" : "returnBookId";
  const boxId = type === "issue" ? "issueDetails" : "returnDetails";
  const code = document.getElementById(inputId).value.trim();
  const box = document.getElementById(boxId);
  if (!code) { box.style.display = "none"; return; }

  const b = books.find(x => (x.code || "").toLowerCase() === code.toLowerCase());
  if (!b) {
    box.innerHTML = "<p style='color:red;'>Book not found!</p>";
    box.style.display = "block";
    return;
  }

  const available = (b.copies || 0) - (b.issuedCount || 0);

  box.style.display = "block";
  box.innerHTML = `
    <p><b>Book Name:</b> ${b.name || "-"}</p>
    <p><b>Author:</b> ${b.author || "-"}</p>
    <p><b>Publisher:</b> ${b.publisher || "-"}</p>
    <p><b>Available Copies:</b> ${available}</p>
  `;
}

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyPP73_WYc68C50lZPG-QWRBTfmLJIyimBLtE7ORQK8hGA_LMu0e63tF8xekYtzpmmp/exec";


/* ----------------------------------------------------
     âœ… CLOUD SYNC â€” LOAD DATA FROM GOOGLE SHEETS
-----------------------------------------------------*/
async function loadCloudRecords() {
  const syncBtn = document.getElementById('syncBtn');
  const syncStatus = document.getElementById('syncStatus');

  if (location.protocol === 'file:' || location.origin === 'null') {
    if (syncStatus) syncStatus.textContent = 'Serve over HTTP to enable cloud sync';
    console.warn('Running from file:// â€” CORS will block Google Apps Script requests. Start a local HTTP server.');
    return;
  }

  try {
    if (syncBtn) syncBtn.disabled = true;
    if (syncStatus) syncStatus.textContent = 'Syncing...';

    const url = SCRIPT_URL + '?action=getData&t=' + Date.now();
    const res = await fetch(url, { cache: 'no-store' });
    const text = await res.text();
    console.log('RAW SERVER RESPONSE:', text.slice(0, 1000));

    let json;
    try {
      json = JSON.parse(text);
    } catch (e) {
      console.error('Cloud load error: server returned non-JSON:', text.slice(0, 500));
      if (syncStatus) syncStatus.textContent = 'Server returned non-JSON';
      alert('Sync failed: server returned non-JSON response. Check console/Network.');
      return;
    }

    if (json.error) {
      console.error('Server error:', json.error);
      if (syncStatus) syncStatus.textContent = 'Server error';
      alert('Sync failed: ' + json.error);
      return;
    }

    const rows = Array.isArray(json.data) ? json.data : [];
    if (rows.length < 2) {
      records = [];
      save();
      render();
      if (syncStatus) syncStatus.textContent = 'No records';
      return;
    }

    const header = rows[0].map(h => (h || '').toString().trim());
    const body = rows.slice(1);

    records = body.map(r => {
      const obj = {};
      header.forEach((col, i) => { obj[col] = r[i]; });
      return {
        code: (obj['code'] || obj['Code'] || obj['Book Code'] || obj['book_code'] || '').toString(),
        name: (obj['name'] || obj['Name'] || obj['Book Name'] || '').toString(),
        author: (obj['author'] || obj['Author'] || '').toString(),
        publisher: (obj['publisher'] || obj['Publisher'] || '').toString(),
        student: (obj['student'] || obj['Student'] || '').toString(),
        date: (obj['date'] || obj['Issue Date'] || '').toString(),
        returnDate: (obj['returnDate'] || obj['Return Date'] || '').toString(),
        status: (obj['status'] || obj['Status'] || '').toString()
      };
    });

    save();
    render();
    if (syncStatus) syncStatus.textContent = 'Synced âœ“';
    setTimeout(() => { if (syncStatus) syncStatus.textContent = ''; }, 2000);
  } catch (err) {
    console.error("Cloud load error:", err);
    console.error("Error message:", err.message);
    console.error("Error stack:", err.stack);
    if (syncStatus) syncStatus.textContent = 'Sync failed: ' + (err.message || 'unknown error');
    alert('Sync failed: ' + (err.message || err) + '. Check console (F12) for details.');
  } finally {
    if (syncBtn) syncBtn.disabled = false;
  }
}


/* ----------------------------------------------------
                 ISSUE BOOK
-----------------------------------------------------*/
function issueBook() {
  const code = document.getElementById("issueBookId").value.trim();
  const student = document.getElementById("issueTo").value.trim();
  const b = books.find(x => (x.code || "").toLowerCase() === code.toLowerCase());

  if (!b) return alert("Book not found!");
  if (!student) return alert("Enter student name!");

  const available = (b.copies || 0) - (b.issuedCount || 0);
  if (available <= 0) return alert("No available copies left!");

  b.issuedCount = (b.issuedCount || 0) + 1;

  const record = {
    code: b.code,
    name: b.name,
    author: b.author,
    publisher: b.publisher,
    student,
    date: new Date().toLocaleString(),
    status: "Issued",
    returnDate: ""
  };

  records.push(record);
  save();
  render();

  (async () => {
    try {
      const form = new URLSearchParams();
      Object.entries({ ...record, action: "ISSUE" }).forEach(([k,v]) => form.append(k, v));
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: form
      });
      const j = await res.json().catch(() => ({}));
       if (!j || !j.success) console.warn('Issue POST response:', j);
     } catch (err) {
       console.error('Issue POST failed:', err);
       alert('Failed to send issue to server. Check console.');
     }
   })();
  alert(`ðŸ“˜ Book "${b.name}" issued to ${student}`);
  resetIssue();
}


/* ----------------------------------------------------
                 RETURN BOOK
-----------------------------------------------------*/
function returnBook() {
  const code = document.getElementById("returnBookId").value.trim();
  const b = books.find(x => (x.code || "").toLowerCase() === code.toLowerCase());
  if (!b) return alert("Book not found!");

  const lastIssued = [...records].reverse().find(x => x.code === b.code && x.status === "Issued");
  if (!lastIssued) return alert("No pending issue record found!");

  b.issuedCount = Math.max((b.issuedCount || 1) - 1, 0);

  lastIssued.status = "Returned";
  lastIssued.returnDate = new Date().toLocaleString();

  save();
  render();

  (async () => {
     try {
      const form = new URLSearchParams();
      Object.entries({ ...lastIssued, action: "RETURN" }).forEach(([k,v]) => form.append(k, v));
      const res = await fetch(SCRIPT_URL, { method: "POST", body: form });
      const j = await res.json().catch(() => ({}));
      if (!j || !j.success) console.warn('Return POST response:', j);
     } catch (err) {
       console.error('Return POST failed:', err);
       alert('Failed to send return to server. Check console.');
     }
   })();
  alert(`ðŸ“— Book "${b.name}" returned`);
  resetReturn();
}


/* ----------------------------------------------------
                 DELETE RECORD
-----------------------------------------------------*/
function deleteRecord(index) {
  if (!confirm("Are you sure you want to delete this record?")) return;

  const rec = records[index];

  const b = books.find(x => x.code === rec.code);
  if (b && rec.status === "Issued") {
    b.issuedCount = Math.max((b.issuedCount || 1) - 1, 0);
  }

  records.splice(index, 1);
  save();
  render();

  (async () => {
     try {
      const form = new URLSearchParams();
      Object.entries({ ...rec, action: "DELETE" }).forEach(([k,v]) => form.append(k, v));
      const res = await fetch(SCRIPT_URL, { method: "POST", body: form });
      const j = await res.json().catch(() => ({}));
      if (!j || !j.success) console.warn('Delete POST response:', j);
     } catch (e) {
       console.warn('Delete response not JSON', e);
     }
   }).catch(err => {
     console.error('Delete POST failed:', err);
   });
}


/* ----------------------------------------------------
                 RENDER TABLE
-----------------------------------------------------*/
function render() {
  const t = document.getElementById("record-table");
  t.innerHTML = `
    <tr>
      <th>Book Code</th>
      <th>Name</th>
      <th>Author</th>
      <th>Student</th>
      <th>Issue Date</th>
      <th>Status</th>
      <th>Return Date</th>
      <th>Delete</th>
    </tr>
  `;

  records.forEach((r, i) => {
    t.innerHTML += `
      <tr>
        <td>${r.code}</td>
        <td>${r.name}</td>
        <td>${r.author}</td>
        <td>${r.student}</td>
        <td>${r.date}</td>
        <td>${r.status}</td>
        <td>${r.returnDate || "-"}</td>
        <td><button class="btn-danger" onclick="deleteRecord(${i})">Delete</button></td>
      </tr>
    `;
  });
}


/* ----------------------------------------------------
                 UTILITIES
-----------------------------------------------------*/
function save() {
  localStorage.setItem(BOOKS_KEY, JSON.stringify(books));
  localStorage.setItem(RECORDS_KEY, JSON.stringify(records));
}

function resetIssue() {
  issueBookId.value = "";
  issueTo.value = "";
  document.getElementById("issueDetails").style.display = "none";
}

function resetReturn() {
  returnBookId.value = "";
  document.getElementById("returnDetails").style.display = "none";
}

function logout() {
  localStorage.removeItem("loggedIn");
  window.location.href = "login.html";
}


/* ----------------------------------------------------
     âš¡ LOAD CLOUD DATA ON PAGE START
-----------------------------------------------------*/
loadCloudRecords();

// add DOM ready handlers to attach sync and auto-sync
window.addEventListener('DOMContentLoaded', () => {
  const syncBtn = document.getElementById('syncBtn');
  if (syncBtn) syncBtn.addEventListener('click', loadCloudRecords);
  // auto-sync when tab becomes active and every 30s (only when served over HTTP)
  if (!(location.protocol === 'file:' || location.origin === 'null')) {
    loadCloudRecords();
    document.addEventListener('visibilitychange', () => { if (!document.hidden) loadCloudRecords(); });
    setInterval(loadCloudRecords, 30000);
  }
});
</script>

</body>
</html>
