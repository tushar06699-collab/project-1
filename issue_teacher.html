<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Issue / Return Books (Teachers)</title>
<style>
  body{font-family:'Poppins',sans-serif;background:#f8f9fa;margin:0;padding:20px;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
  h2{margin:0;color:#022;}
  input,button{padding:10px;margin:6px;border-radius:8px;border:1px solid #ccc;}
  button{cursor:pointer;font-weight:600;border:none;}
  .btn-main{background:linear-gradient(90deg,#34d399,#3ec8ff);color:white;}
  .btn-danger{background:linear-gradient(90deg,#fb7185,#f97316);color:white;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;}
  th{background:#e7f3f0;}
  .details-box{background:white;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:10px;margin:10px 0;}
  .details-box p{margin:4px 0;}
</style>
</head>
<body>

<div class="topbar">
  <h2>üçé Issue / Return Books (Teachers)</h2>
  <div>
    <button onclick="window.location.href='issue_return.html'" class="btn-main">Issue to Students</button>
    <button onclick="window.location.href='books.html'" class="btn-main">Go to Books</button>
    <button id="syncBtn" class="btn-main" title="Sync from cloud">Sync</button>
    <span id="syncStatus" style="margin-left:10px;font-size:0.9em;color:#066;"></span>
    <button onclick="logout()" class="btn-danger">Logout</button>
  </div>
</div>

<div>
  <h3>üìò Issue Book</h3>
  <input id="issueBookId" placeholder="Enter Book Code" oninput="fetchBookDetails('issue')">
  <div id="issueDetails" class="details-box" style="display:none;"></div>
  <input id="issueTo" placeholder="Teacher Name / ID">
  <input type="number" id="issueForDays" placeholder="Issue For Days (Default: 30)" value="30" min="1">
  <button onclick="issueBook()" class="btn-main">Issue</button>
</div>

<div>
  <h3>üìó Return Book</h3>
  <input id="returnBookId" placeholder="Enter Book Code" oninput="fetchBookDetails('return')">
  <div id="returnDetails" class="details-box" style="display:none;"></div>
  <button onclick="returnBook()" class="btn-main">Return</button>
</div>

<h3>üìã Records</h3>
<table id="record-table"></table>

<script>
if (localStorage.getItem("loggedIn") !== "true") window.location.href = "index.html";

const BOOKS_KEY = "booksData_v2";
const RECORDS_KEY = "recordsData_v2_teachers"; // Separate records key for clarity (Optional)
// FINE PER DAY SET TO 0 FOR TEACHERS
const FINE_PER_DAY = 0; 

let books = JSON.parse(localStorage.getItem(BOOKS_KEY) || "[]");
let records = JSON.parse(localStorage.getItem(RECORDS_KEY) || "[]");

if (!Array.isArray(books)) books = [];
if (!Array.isArray(records)) records = [];


// Utility function to calculate date 'days' from a start date
function calculateDueDate(issueDate, days) {
    const date = new Date(issueDate);
    date.setDate(date.getDate() + parseInt(days, 10));
    return date.toLocaleDateString(); 
}

/* ----------------------------------------------------
  ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†FETCH BOOK DETAILS
-----------------------------------------------------*/
function fetchBookDetails(type) {
  const inputId = type === "issue" ? "issueBookId" : "returnBookId";
  const boxId = type === "issue" ? "issueDetails" : "returnDetails";
  const code = document.getElementById(inputId).value.trim();
  const box = document.getElementById(boxId);
  if (!code) { box.style.display = "none"; return; }

  const b = books.find(x => (x.code || "").toLowerCase() === code.toLowerCase());
  if (!b) {
    box.innerHTML = "<p style='color:red;'>Book not found!</p>";
    box.style.display = "block";
    return;
  }

  const available = (b.copies || 0) - (b.issuedCount || 0);

  // Start building the details box HTML
  let detailsHTML = `
    <p><b>Book Name:</b> ${b.name || "-"}</p>
    <p><b>Author:</b> ${b.author || "-"}</p>
    <p><b>Publisher:</b> ${b.publisher || "-"}</p>
    <p><b>Available Copies:</b> ${available}</p>
  `;

  if (type === "return") {
    // Find the currently issued record for this book code
    const issuedRecord = [...records].reverse().find(x => x.code.toLowerCase() === code.toLowerCase() && x.status === "Issued");

    if (issuedRecord) {
      // DISPLAY CHANGE: "Issued to"
      detailsHTML += `
        <hr style="border-top: 1px solid #eee; margin: 8px 0;">
        <p style="color:#022;"><b>Currently Issued to (Teacher):</b> ${issuedRecord.student || "N/A"}</p>
        <p style="color:#022;"><b>Issue Date:</b> ${issuedRecord.date || "-"}</p>
        <p style="color:#022;"><b>Due Date:</b> ${issuedRecord.dueDate || "-"}</p>
      `;
    } else {
      detailsHTML += `<p style='color:green;'>Book is currently **not** issued.</p>`;
    }
  }

  box.style.display = "block";
  box.innerHTML = detailsHTML;
}


const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyO034F6qc_s_sp19Z8RzokgO-zALUUnFcrFqR_hTmM-Mgoyc8-5CZf-n8WsGfv6zJJ/exec";


/* ----------------------------------------------------
  ¬† ¬† ¬† ¬†‚úÖ CLOUD SYNC ‚Äî LOAD DATA FROM GOOGLE SHEETS
-----------------------------------------------------*/
async function loadCloudRecords() {
  const syncBtn = document.getElementById('syncBtn');
  const syncStatus = document.getElementById('syncStatus');

  if (location.protocol === 'file:' || location.origin === 'null') {
    if (syncStatus) syncStatus.textContent = 'Serve over HTTP to enable cloud sync';
    console.warn('Running from file:// ‚Äî CORS will block Google Apps Script requests. Start a local HTTP server.');
    return;
  }

  try {
    if (syncBtn) syncBtn.disabled = true;
    if (syncStatus) syncStatus.textContent = 'Syncing...';

    // ACTION change: Use a specific action for teachers if you want to use a different Sheet/Tab
    const url = SCRIPT_URL + '?action=getDataTeacher&t=' + Date.now(); 
    const res = await fetch(url, { cache: 'no-store' });
    const text = await res.text();
    console.log('RAW SERVER RESPONSE:', text.slice(0, 1000));

    let json;
    try {
      json = JSON.parse(text);
    } catch (e) {
      console.error('Cloud load error: server returned non-JSON:', text.slice(0, 500));
      if (syncStatus) syncStatus.textContent = 'Server returned non-JSON';
      alert('Sync failed: server returned non-JSON response. Check console/Network.');
      return;
    }

    if (json.error) {
      console.error('Server error:', json.error);
      if (syncStatus) syncStatus.textContent = 'Server error';
      alert('Sync failed: ' + json.error);
      return;
    }

    const rows = Array.isArray(json.data) ? json.data : [];
    if (rows.length < 2) {
      records = [];
      save();
      render();
      if (syncStatus) syncStatus.textContent = 'No records';
      return;
    }

    const header = rows[0].map(h => (h || '').toString().trim());
    const body = rows.slice(1);

    records = body.map(r => {
      const obj = {};
      header.forEach((col, i) => { obj[col] = r[i]; });
      return {
        code: (obj['code'] || obj['Code'] || obj['Book Code'] || obj['book_code'] || '').toString(),
        name: (obj['name'] || obj['Name'] || obj['Book Name'] || '').toString(),
        author: (obj['author'] || obj['Author'] || '').toString(),
        publisher: (obj['publisher'] || obj['Publisher'] || '').toString(),
        // Renamed 'student' key to 'teacher' or kept 'student' for Sheets compatibility
        student: (obj['student'] || obj['Student'] || '').toString(), 
        issueDays: parseInt(obj['issueDays'] || obj['Issue Days'] || 0, 10),
        date: (obj['date'] || obj['Issue Date'] || '').toString(),
        dueDate: (obj['dueDate'] || obj['Due Date'] || '').toString(),
        returnDate: (obj['returnDate'] || obj['Return Date'] || '').toString(),
        status: (obj['status'] || obj['Status'] || '').toString(),
        fine: (obj['fine'] || obj['Fine'] || '').toString()
      };
    });

    save();
    render();
    if (syncStatus) syncStatus.textContent = 'Synced ‚úì';
    setTimeout(() => { if (syncStatus) syncStatus.textContent = ''; }, 2000);
  } catch (err) {
    console.error("Cloud load error:", err);
    if (syncStatus) syncStatus.textContent = 'Sync failed: ' + (err.message || 'unknown error');
    alert('Sync failed: ' + (err.message || err) + '. Check console (F12) for details.');
  } finally {
    if (syncBtn) syncBtn.disabled = false;
  }
}


/* ----------------------------------------------------
  ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†ISSUE BOOK
-----------------------------------------------------*/
function issueBook() {
  const code = document.getElementById("issueBookId").value.trim();
  // RETAINING 'student' VARIABLE NAME FOR DATA STRUCTURE CONSISTENCY
  const student = document.getElementById("issueTo").value.trim(); 
  const issueDays = parseInt(document.getElementById("issueForDays").value.trim() || '30', 10); 
  
  const b = books.find(x => (x.code || "").toLowerCase() === code.toLowerCase());

  if (!b) return alert("Book not found!");
  if (!student) return alert("Enter teacher name/ID!"); // ALERT CHANGE
  if (issueDays <= 0) return alert("Issue days must be a positive number!");

  const available = (b.copies || 0) - (b.issuedCount || 0);
  if (available <= 0) return alert("No available copies left!");

  b.issuedCount = (b.issuedCount || 0) + 1;

  const issueDate = new Date();
  const dueDate = calculateDueDate(issueDate, issueDays);

  const record = {
    code: b.code,
    name: b.name,
    author: b.author,
    publisher: b.publisher,
    student,
    issueDays: issueDays, 
    date: issueDate.toLocaleString(), 
    dueDate: dueDate, 
    status: "Issued",
    returnDate: "",
    fine: ""
  };

  records.push(record);
  save();
  render();

  (async () => {
    try {
      const form = new URLSearchParams();
      // ACTION change: Use a specific action for teachers if you want to use a different Sheet/Tab
      Object.entries({ ...record, action: "ISSUE_TEACHER" }).forEach(([k,v]) => form.append(k, v)); 
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: form
      });
      const j = await res.json().catch(() => ({}));
        if (!j || !j.success) console.warn('Issue POST response:', j);
      } catch (err) {
        console.error('Issue POST failed:', err);
        alert('Failed to send issue to server. Check console.');
      }
    })();
  alert(`üìò Book "${b.name}" issued to Teacher: ${student} for ${issueDays} days. Due: ${dueDate}`);
  resetIssue();
}


/* ----------------------------------------------------
  ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†RETURN BOOK
-----------------------------------------------------*/
function returnBook() {
  const code = document.getElementById("returnBookId").value.trim();
  const b = books.find(x => (x.code || "").toLowerCase() === code.toLowerCase());
  if (!b) return alert("Book not found!");

  const lastIssued = [...records].reverse().find(x => x.code === b.code && x.status === "Issued");
  if (!lastIssued) return alert("No pending issue record found!");

  b.issuedCount = Math.max((b.issuedCount || 1) - 1, 0);

  const returnDateObj = new Date();
  lastIssued.status = "Returned";
  lastIssued.returnDate = returnDateObj.toLocaleString();

  // --- FINE CALCULATION LOGIC (Set to 0) ---
  let fine = 0;
  let fineMessage = "";
  
  const dueDateObj = new Date(lastIssued.dueDate);
  dueDateObj.setHours(0, 0, 0, 0); 
  returnDateObj.setHours(0, 0, 0, 0);

  if (returnDateObj > dueDateObj) {
    const diffTime = Math.abs(returnDateObj - dueDateObj);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    
    // Fine is 0, so fine calculation is ignored for teachers unless FINE_PER_DAY is changed
    fine = diffDays * FINE_PER_DAY;
    
    if (fine > 0) {
        lastIssued.fine = `‚Çπ${fine} (${diffDays} days overdue)`;
        fineMessage = ` (Fine: ‚Çπ${fine} for ${diffDays} days overdue)`;
    } else {
        lastIssued.fine = "‚Çπ0 (Overdue, but no fine applied)";
        fineMessage = " (Overdue, but no fine applied)";
    }
  } else {
    lastIssued.fine = "‚Çπ0 (Returned on time)";
  }
  // --- END FINE CALCULATION LOGIC ---

  save();
  render();

  (async () => {
      try {
      const form = new URLSearchParams();
      // ACTION change: Use a specific action for teachers if you want to use a different Sheet/Tab
      Object.entries({ ...lastIssued, action: "RETURN_TEACHER" }).forEach(([k,v]) => form.append(k, v)); 
      const res = await fetch(SCRIPT_URL, { method: "POST", body: form });
      const j = await res.json().catch(() => ({}));
      if (!j || !j.success) console.warn('Return POST response:', j);
      } catch (err) {
        console.error('Return POST failed:', err);
        alert('Failed to send return to server. Check console.');
      }
    })();
  alert(`üìó Book "${b.name}" returned.${fineMessage}`);
  resetReturn();
}


/* ----------------------------------------------------
  ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†DELETE RECORD
-----------------------------------------------------*/
function deleteRecord(index) {
  if (!confirm("Are you sure you want to delete this record?")) return;

  const rec = records[index];

  const b = books.find(x => x.code === rec.code);
  if (b && rec.status === "Issued") {
    b.issuedCount = Math.max((b.issuedCount || 1) - 1, 0);
  }

  records.splice(index, 1);
  save();
  render();

  (async () => {
      try {
      const form = new URLSearchParams();
      // ACTION change: Use a specific action for teachers if you want to use a different Sheet/Tab
      Object.entries({ ...rec, action: "DELETE_TEACHER" }).forEach(([k,v]) => form.append(k, v)); 
      const res = await fetch(SCRIPT_URL, { method: "POST", body: form });
      const j = await res.json().catch(() => ({}));
      if (!j || !j.success) console.warn('Delete POST response:', j);
      } catch (e) {
        console.warn('Delete response not JSON', e);
      }
    }).catch(err => {
      console.error('Delete POST failed:', err);
    });
}


/* ----------------------------------------------------
  ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†RENDER TABLE
-----------------------------------------------------*/
function render() {
  const t = document.getElementById("record-table");
  t.innerHTML = `
    <tr>
      <th>Book Code</th>
      <th>Name</th>
      <th>Teacher / ID</th> <th>Issue Date</th>
      <th>Days</th> 
      <th>Due Date</th> 
      <th>Status</th>
      <th>Return Date</th>
      <th>Fine</th> 
      <th>Delete</th>
    </tr>
  `;

  records.forEach((r, i) => {
    let dueDateObj = r.dueDate ? new Date(r.dueDate) : null;
    let now = new Date();
    now.setHours(0, 0, 0, 0); 

    let rowStyle = '';
    // Overdue highlighting remains useful even if fine is 0
    if (r.status === "Issued" && dueDateObj && now > dueDateObj) {
        rowStyle = 'style="background-color: #fce2e2;"'; 
    }

    t.innerHTML += `
      <tr ${rowStyle}>
        <td>${r.code}</td>
        <td>${r.name}</td>
        <td>${r.student}</td> <td>${r.date}</td>
        <td>${r.issueDays || "-"}</td> 
        <td>${r.dueDate || "-"}</td> 
        <td>${r.status}</td>
        <td>${r.returnDate || "-"}</td>
        <td>${r.fine || "-"}</td> 
        <td><button class="btn-danger" onclick="deleteRecord(${i})">Delete</button></td>
      </tr>
    `;
  });
}


/* ----------------------------------------------------
  ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†UTILITIES
-----------------------------------------------------*/
function save() {
  localStorage.setItem(BOOKS_KEY, JSON.stringify(books));
  localStorage.setItem(RECORDS_KEY, JSON.stringify(records));
}

function resetIssue() {
  issueBookId.value = "";
  issueTo.value = "";
  issueForDays.value = "30"; // Default days reset
  document.getElementById("issueDetails").style.display = "none";
}

function resetReturn() {
  returnBookId.value = "";
  document.getElementById("returnDetails").style.display = "none";
}

function logout() {
  localStorage.removeItem("loggedIn");
  window.location.href = "index.html";
}


/* ----------------------------------------------------
  ¬† ¬† ¬†‚ö° LOAD CLOUD DATA ON PAGE START
-----------------------------------------------------*/
loadCloudRecords();

// add DOM ready handlers to attach sync and auto-sync
window.addEventListener('DOMContentLoaded', () => {
  const syncBtn = document.getElementById('syncBtn');
  if (syncBtn) syncBtn.addEventListener('click', loadCloudRecords);
  if (!(location.protocol === 'file:' || location.origin === 'null')) {
    loadCloudRecords();
    document.addEventListener('visibilitychange', () => { if (!document.hidden) loadCloudRecords(); });
    setInterval(loadCloudRecords, 30000);
  }
});
</script>

</body>
</html>